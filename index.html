<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Pro | Ultimate</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Theme Colors */
            --bg-app: #0d1117;
            --bg-panel: #161b22;
            --bg-active: #21262d;
            --border: #30363d;
            --accent: #58a6ff;
            --text-main: #c9d1d9;
            --text-dim: #8b949e;
            --error: #f85149;
            --success: #3fb950;
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: 50px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
        }

        .brand {
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
            color: #fff;
        }

        .brand i { color: var(--accent); }

        .controls { display: flex; gap: 8px; }

        .btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .btn:hover { background: var(--bg-active); border-color: var(--text-dim); }
        .btn-primary { background: var(--accent); color: #000; border: none; }
        .btn-primary:hover { background: #79c0ff; }

        /* --- Main Layout --- */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-dim);
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
        }

        .file-list { flex: 1; overflow-y: auto; }

        .file-item {
            padding: 8px 20px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 2px solid transparent;
            transition: background 0.1s;
        }

        .file-item:hover { background: var(--bg-active); }
        .file-item.active { background: var(--bg-active); border-left-color: var(--accent); color: white; }
        
        .delete-icon { opacity: 0; font-size: 12px; transition: 0.2s; padding: 4px; border-radius: 4px; }
        .file-item:hover .delete-icon { opacity: 1; }
        .delete-icon:hover { color: var(--error); background: rgba(248,81,73,0.1); }

        /* Editor */
        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-app);
        }

        .tab-strip {
            height: 36px;
            background: var(--bg-app);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-main);
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            border-top: 2px solid transparent;
        }
        
        .tab.active {
            background: var(--bg-app);
            border-top-color: var(--accent);
            color: white;
        }

        textarea {
            flex: 1;
            width: 100%;
            background: transparent;
            color: #e6edf3;
            border: none;
            padding: 20px;
            font-family: var(--font-code);
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            white-space: pre;
        }

        /* Preview */
        .preview-pane {
            width: 40%;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
            background: white;
        }

        iframe { flex: 1; width: 100%; height: 100%; border: none; }

        /* Console */
        .console-panel {
            height: 32px; /* Collapsed height */
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: height 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .console-panel.open { height: 180px; }

        .console-header {
            padding: 0 15px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            background: #21262d;
            color: var(--text-dim);
            user-select: none;
        }
        
        .console-header:hover { color: var(--text-main); }

        .console-body {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            font-family: var(--font-code);
            font-size: 12px;
            color: var(--text-main);
        }

        .log-entry { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid #30363d; display: flex; gap: 10px; }
        .log-time { color: var(--accent); opacity: 0.7; min-width: 60px; }
        .log-msg { white-space: pre-wrap; word-break: break-all; }
        .log-err { color: var(--error); }
        .log-warn { color: #d29922; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(2px);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 25px;
            border-radius: 8px;
            width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .modal input { width: 100%; padding: 10px; margin-bottom: 15px; background: var(--bg-app); border: 1px solid var(--border); color: white; border-radius: 4px; outline: none; }
        .modal input:focus { border-color: var(--accent); }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fa-solid fa-code"></i> STUDIO PRO
        </div>
        <div class="controls">
            <button class="btn" onclick="openFullView()" title="Open in new tab"><i class="fa-solid fa-external-link-alt"></i> Full View</button>
            <button class="btn" onclick="openNewFileModal()"><i class="fa-solid fa-plus"></i> New File</button>
            <button class="btn" onclick="downloadProject()"><i class="fa-solid fa-download"></i> Download ZIP</button>
            <button class="btn" onclick="resetProject()"><i class="fa-solid fa-rotate-right"></i> Reset</button>
        </div>
    </header>

    <div class="workspace">
        <div class="sidebar">
            <div class="sidebar-header">
                EXPLORER
                <span id="file-count" style="background: var(--bg-active); padding: 2px 6px; border-radius: 10px;">1</span>
            </div>
            <div id="file-list" class="file-list"></div>
        </div>

        <div class="editor-pane">
            <div class="tab-strip">
                <div class="tab active">
                    <i id="tab-icon" class="fa-brands fa-html5" style="color: #e34c26;"></i>
                    <span id="tab-name">index.html</span>
                </div>
            </div>
            <textarea id="code-editor" spellcheck="false" placeholder="// Start coding..."></textarea>
        </div>

        <div class="preview-pane">
            <iframe id="preview-frame" sandbox="allow-scripts allow-modals allow-forms allow-popups"></iframe>
            
            <div class="console-panel" id="console-panel">
                <div class="console-header" onclick="toggleConsole()">
                    <span><i class="fa-solid fa-terminal"></i> TERMINAL / LOGS</span>
                    <span id="status-ind" style="display:flex; align-items:center; gap:5px; font-weight:normal;">
                        <span style="width:8px; height:8px; background:var(--success); border-radius:50%;"></span> Ready
                    </span>
                </div>
                <div id="console-logs" class="console-body">
                    <div style="color: #555; font-style: italic;">Console output will appear here...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h3 style="margin-bottom: 10px; color: var(--text-main); font-size: 14px;">Create New File</h3>
            <input type="text" id="filename-input" placeholder="style.css, script.js, or about.html">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1" onclick="createFile()">Create</button>
                <button class="btn" style="flex:1" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & STATE ---
        const DEFAULT_PROJECT = {
            'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My App</title>
</head>
<body>
  <div class="container">
    <h1>Welcome to Studio Pro</h1>
    <p>Click "Full View" to see this in a new tab!</p>
    <button onclick="hello()">Test Console</button>
  </div>
</body>
</html>`,
            'style.css': `body { font-family: sans-serif; text-align: center; padding: 50px; background: #f0f0f0; }
.container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
button:hover { background: #0056b3; }`,
            'script.js': `function hello() {
  console.log("Hello from the Virtual Console!");
  alert("It works!");
}`
        };

        // Load from LocalStorage or use Default
        let vfs = JSON.parse(localStorage.getItem('studio_pro_v5')) || JSON.parse(JSON.stringify(DEFAULT_PROJECT));
        let activeFile = 'index.html';

        // Elements
        const editor = document.getElementById('code-editor');
        const fileList = document.getElementById('file-list');
        const previewFrame = document.getElementById('preview-frame');
        const consoleLogs = document.getElementById('console-logs');
        const statusInd = document.getElementById('status-ind');
        const modal = document.getElementById('modal-overlay');

        // --- 2. COMPILER ENGINE ---
        // Combines all files into one string for Iframe or Full View
        function compileProject() {
            let html = vfs['index.html'] || "<h1>No index.html found</h1>";
            let cssBundle = "";
            let jsBundle = "";

            // Gather Assets
            Object.keys(vfs).forEach(name => {
                if (name.endsWith('.css')) cssBundle += `\n/* ${name} */\n${vfs[name]}`;
                if (name.endsWith('.js')) jsBundle += `\n// ${name}\n${vfs[name]}`;
            });

            // Proxy Script: Intercepts console and errors to send back to Studio
            const proxyScript = `
            <script>
                (function() {
                    function send(type, msg) {
                        const payload = { source: 'studio-pro', type: type, message: msg };
                        if (window.opener) window.opener.postMessage(payload, '*'); // If in new tab
                        else window.parent.postMessage(payload, '*'); // If in iframe
                    }

                    // Catch Errors
                    window.onerror = function(msg, url, line) {
                        send('error', msg + " (Line: " + line + ")");
                        return false;
                    };

                    // Intercept Console
                    const _log = console.log;
                    const _warn = console.warn;
                    const _error = console.error;

                    console.log = function(...args) { send('log', args.join(' ')); _log.apply(console, args); };
                    console.warn = function(...args) { send('warn', args.join(' ')); _warn.apply(console, args); };
                    console.error = function(...args) { send('error', args.join(' ')); _error.apply(console, args); };
                })();
            <\/script>`;

            // Inject Logic
            let doc = html;
            
            // Add CSS
            if (doc.includes('</head>')) doc = doc.replace('</head>', `<style>${cssBundle}</style></head>`);
            else doc = `<style>${cssBundle}</style>` + doc;

            // Add Proxy (First in body)
            if (doc.includes('<body>')) doc = doc.replace('<body>', `<body>${proxyScript}`);
            else doc = proxyScript + doc;

            // Add JS (Last in body, wrapped in Try/Catch)
            const safeJs = `<script>try { ${jsBundle} } catch(e) { console.error(e.message); }<\/script>`;
            if (doc.includes('</body>')) doc = doc.replace('</body>', `${safeJs}</body>`);
            else doc += safeJs;

            return doc;
        }

        // --- 3. CORE FUNCTIONS ---

        function updatePreview() {
            // Save state
            vfs[activeFile] = editor.value;
            localStorage.setItem('studio_pro_v5', JSON.stringify(vfs));
            
            // Render
            previewFrame.srcdoc = compileProject();
            
            // Reset status (unless error comes in immediately)
            statusInd.innerHTML = `<span style="width:8px; height:8px; background:var(--success); border-radius:50%;"></span> Ready`;
        }

        function openFullView() {
            vfs[activeFile] = editor.value; // Ensure saved
            const finalCode = compileProject();
            
            const win = window.open('', '_blank');
            if (win) {
                win.document.open();
                win.document.write(finalCode);
                win.document.close();
            } else {
                alert("Popup blocked! Please allow popups for this site to use Full View.");
            }
        }

        function renderSidebar() {
            fileList.innerHTML = '';
            document.getElementById('file-count').innerText = Object.keys(vfs).length;

            Object.keys(vfs).forEach(name => {
                const item = document.createElement('div');
                item.className = `file-item ${name === activeFile ? 'active' : ''}`;
                
                const icon = getFileIcon(name);
                const color = getFileColor(name);

                item.innerHTML = `
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="${icon}" style="color: ${name === activeFile ? '#fff' : color}"></i>
                        ${name}
                    </div>
                    ${name !== 'index.html' ? `<i class="fa-solid fa-trash delete-icon" onclick="deleteFile('${name}', event)"></i>` : ''}
                `;
                
                item.onclick = (e) => {
                    if (!e.target.classList.contains('delete-icon')) switchFile(name);
                };
                
                fileList.appendChild(item);
            });
        }

        function switchFile(name) {
            vfs[activeFile] = editor.value; // Save current
            activeFile = name;
            editor.value = vfs[name];
            
            // Update Tab Info
            document.getElementById('tab-name').innerText = name;
            const icon = document.getElementById('tab-icon');
            icon.className = getFileIcon(name);
            icon.style.color = getFileColor(name);

            renderSidebar();
            updatePreview();
        }

        // --- 4. UTILS & HELPERS ---

        function getFileIcon(name) {
            if (name.endsWith('.html')) return 'fa-brands fa-html5';
            if (name.endsWith('.css')) return 'fa-brands fa-css3-alt';
            if (name.endsWith('.js')) return 'fa-brands fa-js';
            return 'fa-solid fa-file';
        }

        function getFileColor(name) {
            if (name.endsWith('.html')) return '#e34c26';
            if (name.endsWith('.css')) return '#563d7c';
            if (name.endsWith('.js')) return '#f1e05a';
            return '#8b949e';
        }

        function deleteFile(name, e) {
            e.stopPropagation();
            if (confirm(`Permanently delete ${name}?`)) {
                delete vfs[name];
                if (activeFile === name) switchFile('index.html');
                else {
                    localStorage.setItem('studio_pro_v5', JSON.stringify(vfs));
                    renderSidebar();
                    updatePreview();
                }
            }
        }

        function createFile() {
            const name = document.getElementById('filename-input').value.trim();
            if (name && !vfs[name]) {
                vfs[name] = "";
                closeModal();
                switchFile(name);
            } else if (vfs[name]) {
                alert("File already exists!");
            }
        }

        function resetProject() {
            if (confirm("Reset to default project? All changes will be lost.")) {
                vfs = JSON.parse(JSON.stringify(DEFAULT_PROJECT));
                switchFile('index.html');
            }
        }

        async function downloadProject() {
            const zip = new JSZip();
            Object.keys(vfs).forEach(name => zip.file(name, vfs[name]));
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "studio-project.zip";
            link.click();
        }

        // --- 5. LOGGING SYSTEM (PostMessage) ---
        window.addEventListener('message', (event) => {
            const data = event.data;
            if (data && data.source === 'studio-pro') {
                // Clear placeholder if present
                if (consoleLogs.innerHTML.includes('Console output')) consoleLogs.innerHTML = '';

                const div = document.createElement('div');
                div.className = 'log-entry';
                
                let typeClass = 'log-msg';
                if (data.type === 'error') typeClass += ' log-err';
                if (data.type === 'warn') typeClass += ' log-warn';

                div.innerHTML = `
                    <div class="log-time">[${new Date().toLocaleTimeString('en-US',{hour12:false})}]</div>
                    <div class="${typeClass}">${data.message}</div>
                `;
                consoleLogs.appendChild(div);
                consoleLogs.scrollTop = consoleLogs.scrollHeight;

                if (data.type === 'error') {
                    document.getElementById('console-panel').classList.add('open');
                    statusInd.innerHTML = `<span style="width:8px; height:8px; background:var(--error); border-radius:50%;"></span> Error`;
                }
            }
        });

        // --- 6. EVENT LISTENERS ---
        function toggleConsole() { document.getElementById('console-panel').classList.toggle('open'); }
        function openNewFileModal() { modal.style.display = 'flex'; document.getElementById('filename-input').focus(); }
        function closeModal() { modal.style.display = 'none'; document.getElementById('filename-input').value = ''; }
        
        modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
        document.getElementById('filename-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') createFile(); });

        // Auto-update delay
        let timeout;
        editor.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(updatePreview, 500);
        });

        // Initialize
        editor.value = vfs[activeFile];
        renderSidebar();
        updatePreview();

    </script>
</body>
</html>
