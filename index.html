<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Pro | Master Edition</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --bg-app: #0d1117;       /* Darkest Github bg */
            --bg-panel: #161b22;     /* Panel bg */
            --bg-active: #21262d;    /* Active item bg */
            --border: #30363d;       /* Border color */
            --accent: #58a6ff;       /* Blue accent */
            --text-main: #c9d1d9;    /* Main text */
            --text-dim: #8b949e;     /* Dimmed text */
            --error: #f85149;        /* Red error */
            --success: #3fb950;      /* Green success */
            --warn: #d29922;         /* Yellow warning */
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            height: 50px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .brand {
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
        }

        .brand i { color: var(--accent); }

        .controls { display: flex; gap: 10px; }

        .btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .btn:hover { background: var(--bg-active); border-color: var(--text-dim); }
        .btn-primary { background: var(--accent); color: #000; border: none; }
        .btn-primary:hover { background: #79c0ff; }

        /* --- LAYOUT --- */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-dim);
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-list { flex: 1; overflow-y: auto; }

        .file-item {
            padding: 8px 20px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.1s;
            border-left: 2px solid transparent;
        }

        .file-item:hover { background: var(--bg-active); }
        .file-item.active { background: var(--bg-active); border-left-color: var(--accent); color: white; }
        
        .file-name { display: flex; align-items: center; gap: 8px; }
        .file-actions { opacity: 0; transition: opacity 0.2s; }
        .file-item:hover .file-actions { opacity: 1; }
        .delete-icon { color: var(--text-dim); padding: 2px 6px; border-radius: 4px; }
        .delete-icon:hover { color: var(--error); background: rgba(248,81,73,0.1); }

        /* EDITOR */
        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-app);
            position: relative;
        }

        .tab-strip {
            height: 36px;
            background: var(--bg-app);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-main);
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            border-top: 2px solid transparent;
        }
        
        .tab.active {
            background: var(--bg-app);
            border-top-color: var(--accent);
        }

        textarea {
            flex: 1;
            width: 100%;
            background: transparent;
            color: #e6edf3;
            border: none;
            padding: 20px;
            font-family: var(--font-code);
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            white-space: pre;
        }

        /* PREVIEW */
        .preview-pane {
            width: 40%;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
            background: white;
        }

        iframe { flex: 1; width: 100%; height: 100%; border: none; }

        /* TERMINAL / CONSOLE */
        .console-panel {
            height: 0; /* Hidden by default, expands on error/click */
            min-height: 30px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: height 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .console-panel.open { height: 180px; }

        .console-header {
            padding: 0 15px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            background: #21262d;
            color: var(--text-dim);
            user-select: none;
        }

        .console-header:hover { color: var(--text-main); }

        .console-body {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            font-family: var(--font-code);
            font-size: 12px;
            color: var(--text-main);
        }

        .log-entry { margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid #30363d; display: flex; gap: 10px; }
        .log-time { color: #58a6ff; min-width: 60px; }
        .log-msg { white-space: pre-wrap; word-break: break-all; }
        .log-error { color: var(--error); }
        .log-warn { color: var(--warn); }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(2px);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 25px;
            border-radius: 8px;
            width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideUp 0.2s ease-out;
        }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal h3 { font-size: 14px; margin-bottom: 15px; }
        .modal input { width: 100%; padding: 8px; margin-bottom: 15px; background: var(--bg-app); border: 1px solid var(--border); color: white; border-radius: 4px; outline: none; }
        .modal input:focus { border-color: var(--accent); }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fa-solid fa-code"></i>
            STUDIO PRO
        </div>
        <div class="controls">
            <button class="btn" onclick="openNewFileModal()"><i class="fa-solid fa-plus"></i> New File</button>
            <button class="btn" onclick="downloadProject()"><i class="fa-solid fa-download"></i> Export ZIP</button>
            <button class="btn" onclick="resetProject()"><i class="fa-solid fa-rotate-right"></i> Reset</button>
        </div>
    </header>

    <div class="workspace">
        
        <div class="sidebar">
            <div class="sidebar-header">
                EXPLORER
                <span id="file-count" style="background: var(--bg-active); padding: 2px 6px; border-radius: 10px;">1</span>
            </div>
            <div id="file-list" class="file-list">
                </div>
        </div>

        <div class="editor-pane">
            <div class="tab-strip">
                <div class="tab active">
                    <i id="tab-icon" class="fa-brands fa-html5" style="color: #e34c26;"></i>
                    <span id="tab-name">index.html</span>
                </div>
            </div>
            <textarea id="code-editor" spellcheck="false" placeholder="Start coding here..."></textarea>
        </div>

        <div class="preview-pane">
            <iframe id="preview-frame" sandbox="allow-scripts allow-modals allow-forms allow-popups"></iframe>
            
            <div class="console-panel" id="console-panel">
                <div class="console-header" onclick="toggleConsole()">
                    <span><i class="fa-solid fa-terminal"></i> CONSOLE / ERRORS</span>
                    <span id="status-indicator" style="display:flex; align-items:center; gap:5px; font-weight:normal;">
                        <span style="width:8px; height:8px; background:var(--success); border-radius:50%; display:inline-block;"></span> Ready
                    </span>
                </div>
                <div class="console-body" id="console-logs">
                    <div style="color: #8b949e; font-style: italic;">Application logs will appear here...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h3>Create New File</h3>
            <input type="text" id="filename-input" placeholder="e.g. style.css or script.js">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1" onclick="createFile()">Create</button>
                <button class="btn" style="flex:1" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. STATE MANAGEMENT ---
        const DEFAULT_PROJECT = {
            'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Project</title>
</head>
<body>
    <div class="container">
        <h1>Hello World</h1>
        <p>Edit index.html to start building.</p>
        <button onclick="test()">Click Me</button>
    </div>
</body>
</html>`,
        };

        let vfs = JSON.parse(localStorage.getItem('studio_vfs_final')) || JSON.parse(JSON.stringify(DEFAULT_PROJECT));
        let activeFile = 'index.html';

        // --- 2. DOM ELEMENTS ---
        const editor = document.getElementById('code-editor');
        const fileList = document.getElementById('file-list');
        const previewFrame = document.getElementById('preview-frame');
        const consoleLogs = document.getElementById('console-logs');
        const consolePanel = document.getElementById('console-panel');
        const statusInd = document.getElementById('status-indicator');
        const tabName = document.getElementById('tab-name');
        const tabIcon = document.getElementById('tab-icon');
        const fileCount = document.getElementById('file-count');

        // --- 3. FILE SYSTEM LOGIC ---

        function saveState() {
            localStorage.setItem('studio_vfs_final', JSON.stringify(vfs));
        }

        function getIconClass(filename) {
            if (filename.endsWith('.html')) return 'fa-brands fa-html5';
            if (filename.endsWith('.css')) return 'fa-brands fa-css3-alt';
            if (filename.endsWith('.js')) return 'fa-brands fa-js';
            return 'fa-solid fa-file';
        }

        function getIconColor(filename) {
            if (filename.endsWith('.html')) return '#e34c26';
            if (filename.endsWith('.css')) return '#563d7c';
            if (filename.endsWith('.js')) return '#f1e05a';
            return '#8b949e';
        }

        function renderSidebar() {
            fileList.innerHTML = '';
            const files = Object.keys(vfs);
            fileCount.innerText = files.length;

            files.forEach(name => {
                const item = document.createElement('div');
                item.className = `file-item ${name === activeFile ? 'active' : ''}`;
                
                const iconClass = getIconClass(name);
                const iconColor = getIconColor(name);

                item.innerHTML = `
                    <div class="file-name">
                        <i class="${iconClass}" style="color: ${name === activeFile ? 'white' : iconColor}"></i>
                        ${name}
                    </div>
                    ${name !== 'index.html' ? `<div class="file-actions"><i class="fa-solid fa-trash delete-icon" onclick="deleteFile('${name}', event)"></i></div>` : ''}
                `;
                item.onclick = (e) => {
                    // Prevent switching if delete button clicked
                    if (!e.target.classList.contains('delete-icon')) {
                        switchFile(name);
                    }
                };
                fileList.appendChild(item);
            });
        }

        function switchFile(name) {
            // Save current file before switching
            vfs[activeFile] = editor.value;
            saveState();

            activeFile = name;
            editor.value = vfs[name];
            
            // Update Tab
            tabName.innerText = name;
            tabIcon.className = getIconClass(name);
            tabIcon.style.color = getIconColor(name);

            renderSidebar();
            
            // If switching to JS/HTML/CSS, we update preview to reflect changes
            updatePreview();
        }

        function createFile() {
            const input = document.getElementById('filename-input');
            const name = input.value.trim();
            
            if (!name) return alert("Filename cannot be empty.");
            if (vfs[name]) return alert("File already exists.");

            vfs[name] = ""; // Init empty file
            closeModal();
            input.value = "";
            switchFile(name);
        }

        function deleteFile(name, event) {
            event.stopPropagation(); // Stop click from triggering file switch
            if (confirm(`Are you sure you want to delete ${name}?`)) {
                delete vfs[name];
                if (activeFile === name) {
                    switchFile('index.html');
                } else {
                    saveState();
                    renderSidebar();
                    updatePreview();
                }
            }
        }

        function resetProject() {
            if (confirm("This will delete all files and reset to default. Continue?")) {
                vfs = JSON.parse(JSON.stringify(DEFAULT_PROJECT));
                activeFile = 'index.html';
                switchFile('index.html');
            }
        }

        // --- 4. PREVIEW COMPILER & ERROR HANDLING ---

        function updatePreview() {
            // 1. Save current editor content to VFS
            vfs[activeFile] = editor.value;
            saveState();

            // 2. Prepare Bundles
            let htmlContent = vfs['index.html'] || "<h1>No index.html found</h1>";
            let cssBundle = "";
            let jsBundle = "";

            Object.keys(vfs).forEach(filename => {
                if (filename.endsWith('.css')) {
                    cssBundle += `\n/* ${filename} */\n${vfs[filename]}`;
                }
                if (filename.endsWith('.js')) {
                    jsBundle += `\n// ${filename}\n${vfs[filename]}`;
                }
            });

            // 3. Construct the Error & Log Proxy Script
            // This script intercepts console calls and errors inside the iframe
            // and sends them to the parent window via postMessage
            const proxyScript = `
                <script>
                    (function() {
                        function send(type, msg, source) {
                            window.parent.postMessage({
                                source: 'studio-pro',
                                type: type,
                                message: msg
                            }, '*');
                        }

                        // Catch Syntax/Runtime Errors
                        window.onerror = function(msg, url, line, col, error) {
                            send('error', msg + " (Line: " + line + ")");
                            return false;
                        };

                        // Catch Unhandled Promise Rejections
                        window.onunhandledrejection = function(e) {
                            send('error', "Unhandled Promise: " + e.reason);
                        };

                        // Hijack Console
                        const oldLog = console.log;
                        const oldWarn = console.warn;
                        const oldError = console.error;

                        console.log = function(...args) { send('log', args.join(' ')); oldLog.apply(console, args); };
                        console.warn = function(...args) { send('warn', args.join(' ')); oldWarn.apply(console, args); };
                        console.error = function(...args) { send('error', args.join(' ')); oldError.apply(console, args); };
                    })();
                <\/script>
            `;

            // 4. Inject Content
            // We use simple string replacement to inject CSS into head and JS into body
            let finalDoc = htmlContent;

            // Inject CSS
            if (finalDoc.includes('</head>')) {
                finalDoc = finalDoc.replace('</head>', `<style>${cssBundle}</style></head>`);
            } else {
                finalDoc += `<style>${cssBundle}</style>`;
            }

            // Inject Proxy Script (First thing in body or at top)
            if (finalDoc.includes('<body>')) {
                finalDoc = finalDoc.replace('<body>', `<body>${proxyScript}`);
            } else {
                finalDoc = proxyScript + finalDoc;
            }

            // Inject User JS (Last thing in body)
            // We wrap user JS in a try-catch block for extra safety on immediate execution errors
            const safeJs = `
                <script>
                    try {
                        ${jsBundle}
                    } catch (e) {
                        console.error(e.message);
                    }
                <\/script>
            `;

            if (finalDoc.includes('</body>')) {
                finalDoc = finalDoc.replace('</body>', `${safeJs}</body>`);
            } else {
                finalDoc += safeJs;
            }

            // 5. Render
            previewFrame.srcdoc = finalDoc;
            
            // Clear status (will update if error comes in)
            statusInd.innerHTML = `<span style="width:8px; height:8px; background:var(--success); border-radius:50%;"></span> Ready`;
        }

        // --- 5. PARENT WINDOW LISTENER (LOGS) ---
        window.addEventListener('message', (event) => {
            const data = event.data;
            if (data && data.source === 'studio-pro') {
                logToConsole(data.type, data.message);
            }
        });

        function logToConsole(type, msg) {
            // If it's the first log, clear the "placeholder" text
            if (consoleLogs.innerHTML.includes('Application logs will appear here')) {
                consoleLogs.innerHTML = '';
            }

            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const div = document.createElement('div');
            div.className = 'log-entry';
            
            // Styling based on type
            let colorClass = 'log-msg';
            if (type === 'error') colorClass += ' log-error';
            if (type === 'warn') colorClass += ' log-warn';

            div.innerHTML = `
                <div class="log-time">[${time}]</div>
                <div class="${colorClass}">${msg}</div>
            `;
            
            consoleLogs.appendChild(div);
            consoleLogs.scrollTop = consoleLogs.scrollHeight; // Auto-scroll

            // If Error, Auto-open console and update status
            if (type === 'error') {
                statusInd.innerHTML = `<span style="width:8px; height:8px; background:var(--error); border-radius:50%;"></span> Error`;
                consolePanel.classList.add('open');
            }
        }

        function toggleConsole() {
            consolePanel.classList.toggle('open');
        }

        // --- 6. EXPORT / MODAL UTILS ---

        function openNewFileModal() {
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('filename-input').focus();
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        async function downloadProject() {
            const zip = new JSZip();
            Object.keys(vfs).forEach(filename => {
                zip.file(filename, vfs[filename]);
            });
            
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "studio-project.zip";
            link.click();
        }

        // --- 7. INITIALIZATION ---
        
        // Listen for typing
        editor.addEventListener('input', () => {
            // Debounce preview updates slightly for performance
            clearTimeout(window.updateTimer);
            window.updateTimer = setTimeout(updatePreview, 500);
        });

        // Close modal on outside click
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'modal-overlay') closeModal();
        });
        
        // Close modal on Enter key
        document.getElementById('filename-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createFile();
        });

        // Start
        editor.value = vfs[activeFile];
        renderSidebar();
        updatePreview();

    </script>
</body>
</html>
